# Hysteria 2 多协议一键安装脚本 (增强版-自用)

## 简介

这是一个基于V2Ray-Agent的八合一共存脚本，专门用于安装和管理Hysteria 2等多种代理协议的自动化部署脚本。该脚本支持多种操作系统，提供完整的安装、配置、管理功能，并集成了多项增强特性。

本仓库仅供自用，不会回复任何问题，更新频率完全随机。

## 🆕 新增 main.sh 统一管理脚本

我们现在提供了一个全新的 `main.sh` 统一管理脚本，提供更智能的环境初始化和脚本选择功能：

### 主要特性
- **🧠 智能 Swap 管理**: 自动检测内存大小并推荐合适的 swap 配置
- **🎯 灵活选择**: 提供自动创建、手动设置、跳过创建三种选项
- **📋 脚本管理**: 统一管理所有脚本的启动和切换
- **🔧 环境检查**: 自动检查 root 权限和虚拟化环境兼容性
- **🆕 🔄 自动更新**: 内置脚本自动更新功能，保持最新版本
- **⏰ 定时重启**: V2Ray 安装后自动配置系统定时重启

### 使用方法
```bash
# 赋予执行权限
chmod +x main.sh

# 运行统一管理脚本
sudo ./main.sh
```

### Swap 智能管理规则
- **内存 < 1GB**: 推荐创建 2GB swap
- **内存 ≥ 1GB**: 推荐创建 1GB swap
- **已存在 swap**: 自动跳过创建
- **手动设置**: 允许用户自定义任意大小的 swap

### 脚本选择菜单
1. **V2Ray 一键安装脚本** - 运行 `v2ray.sh` (含自动定时重启配置)
2. **完整安装脚本** - 运行 `install.sh`  
3. **Swap 管理脚本** - 运行 `swap.sh`
4. **🆕 更新 main.sh 脚本** - 检查并更新到最新版本
5. **退出程序**


## 支持的系统

- **CentOS** 7/8
- **Debian** 9/10/11
- **Ubuntu** 18.04/20.04/22.04
- **Alpine Linux**

## 支持的协议

- **Hysteria 2** - 基于QUIC协议的高性能代理 (含自动端口跳跃)
- **REALITY** - 新一代反审查协议
- **Tuic** - 基于QUIC的轻量级代理
- **V2Ray** - 多协议代理平台
- **Xray** - V2Ray的超集版本
- **sing-box** - 新一代多协议代理工具

## 🆕 增强功能特性

### 🚀 自动端口跳跃
- **范围**: 30000-40000 (自动配置)
- **协议**: 专为Hysteria 2优化
- **智能**: 安装时自动配置，无需手动设置
- **持久化**: 自动保存到iptables-persistent

### 🛡️ 防火墙增强
- **iptables-persistent**: 自动安装和配置
- **规则持久化**: 重启后自动恢复防火墙规则
- **智能检测**: 避免重复安装和配置冲突

### ⏰ 系统维护自动化
- **定时重启**: 每日凌晨5:00自动重启
- **性能优化**: 保持系统最佳运行状态
- **智能管理**: 自动添加/清理定时任务

## 一键安装
### 使用 main.sh 统一管理脚本
```bash
bash <(wget -o- -qO- https://raw.githubusercontent.com/charleslkx/hy2/master/main.sh)
```

## 文件说明

### 核心脚本文件
- **`main.sh`** - 🆕 统一管理脚本，智能 swap 管理 + 脚本选择菜单 + 自动更新功能
- **`install.sh`** - 主安装脚本，八合一共存 + 增强功能
- **`v2ray.sh`** - V2Ray 专用安装脚本 + 自动定时重启配置
- **`swap.sh`** - 专用 swap 管理脚本
- **`README.md`** - 详细使用说明文档

## 主要功能

### 1. 安装功能
- **一键安装**: 自动检测系统并安装所需组件
- **任意组合安装**: 支持多协议共存
- **自动依赖管理**: 自动安装必要的系统工具和依赖
- **iptables-persistent**: 自动安装并配置防火墙规则持久化
- **端口跳跃**: Hysteria 2自动配置端口跳跃(30000-40000)
- **定时维护**: 自动配置系统定时重启任务

### 2. 协议管理
- **Hysteria 2管理**: 端口跳跃、速度配置、用户管理 (自动端口跳跃)
- **REALITY管理**: 密钥生成、流量伪装
- **Tuic管理**: 配置优化、连接管理

### 3. 工具管理
- **用户管理**: 添加、删除、修改用户配置
- **伪装站管理**: 配置反向代理和伪装网站
- **证书管理**: 自动申请、更新SSL/TLS证书
- **CDN节点管理**: 优化全球访问速度
- **分流工具**: 智能路由和流量分流
- **新端口添加**: 动态端口配置
- **BT下载管理**: 流量控制和管理
- **域名黑名单**: 访问控制和安全防护
- **系统维护**: 自动配置定时重启任务

### 4. 版本管理
- **Core管理**: V2Ray、Xray、sing-box版本管理
- **脚本更新**: 自动检查和更新脚本版本
- **BBR安装**: 网络优化和加速

### 5. 安全功能
- **SELinux检查**: 自动检测和提示SELinux配置
- **防火墙配置**: 自动配置iptables规则
- **证书自动更新**: 定时任务自动续期证书
- **端口安全**: 动态端口和安全配置
- **规则持久化**: iptables-persistent自动保存防火墙规则

### 6. 🆕 系统维护功能
- **定时重启**: 每日凌晨5:00自动重启系统
- **性能优化**: 保持系统最佳运行状态
- **自动清理**: 卸载时自动清理所有配置
- **智能管理**: 避免重复配置和冲突

## 🆕 增强版特性说明

### 自动端口跳跃配置
- **自动激活**: 安装Hysteria 2时自动配置端口跳跃
- **端口范围**: 30000-40000 (固定范围，无需用户设置)
- **iptables规则**: 自动添加NAT转发规则
- **防火墙开放**: 自动开放UDP端口范围
- **规则持久化**: 通过iptables-persistent自动保存

### iptables-persistent自动安装
- **智能检测**: 仅在Debian/Ubuntu系统上安装
- **避免重复**: 检查是否已安装，避免重复配置
- **自动配置**: 预设置配置选项，避免交互式提示
- **规则保存**: 自动保存防火墙规则，重启后生效

### 系统定时重启管理
- **自动添加**: 安装时自动添加每日凌晨5:00重启任务
- **智能检测**: 避免重复添加相同的定时任务
- **完整清理**: 卸载时自动清理定时重启任务
- **用户友好**: 详细的设置完成提醒和管理指导

## 使用说明

### 🆕 推荐流程 - 使用 main.sh 统一管理

#### 1. 环境初始化
```bash
# 下载并运行统一管理脚本
wget -O main.sh https://raw.githubusercontent.com/charleslkx/hy2/master/main.sh
chmod +x main.sh
sudo ./main.sh
```

#### 2. 自动环境检查
脚本会自动进行以下检查：
- **Root 权限验证**
- **OpenVZ 虚拟化兼容性检查**
- **系统内存检测和 Swap 管理**

#### 3. 智能 Swap 配置
根据系统内存自动推荐：
- 内存 < 1GB：推荐 2GB swap
- 内存 ≥ 1GB：推荐 1GB swap

用户可选择：
- **自动创建推荐大小**
- **手动指定 swap 大小**
- **跳过 swap 创建**

#### 4. 脚本选择和执行
通过友好的菜单界面选择：
1. V2Ray 一键安装脚本 (含自动定时重启配置)
2. 完整安装脚本 (推荐)
3. Swap 管理脚本
4. **🆕 更新 main.sh 脚本** (保持最新版本)
5. 退出

#### 5. 🆕 脚本自动更新
main.sh 提供四种更新模式：
- **智能检查更新**: 仅在有新版本时更新
- **强制重新下载**: 无条件重新下载最新版本
- **查看版本信息**: 显示当前脚本详细信息
- **安全备份恢复**: 自动备份原版本，失败时恢复

### 传统流程 - 直接安装

#### 首次安装
1. 运行脚本后会自动检测系统环境
2. 选择 "1.安装" 进行首次安装
3. 根据提示选择需要安装的协议
4. 输入域名等必要信息
5. 脚本将自动完成所有配置（包括端口跳跃和定时重启）

### 🆕 增强版安装流程 (通过 main.sh)
1. **环境检查**: 自动检查 root 权限和虚拟化兼容性
2. **Swap 管理**: 智能检测内存并推荐 swap 配置
3. **脚本选择**: 通过菜单选择要运行的具体安装脚本
4. **自动安装**: 运行选定的脚本完成安装
5. **返回菜单**: 安装完成后可继续选择其他脚本

### 传统增强版安装流程 (直接运行 install.sh)
1. **系统检测**: 自动检测并安装iptables-persistent
2. **协议安装**: 安装选定的代理协议
3. **端口跳跃**: Hysteria 2自动配置30000-40000端口跳跃
4. **防火墙配置**: 自动配置并持久化iptables规则
5. **定时维护**: 自动添加每日凌晨5:00重启任务
6. **配置完成**: 显示详细的配置信息和管理指导

### 管理现有安装
- **选项4**: Hysteria2管理 - 配置端口、速度、用户等 (含端口跳跃管理)
- **选项5**: REALITY管理 - 管理REALITY协议配置
- **选项6**: Tuic管理 - 管理Tuic协议配置
- **选项7**: 用户管理 - 添加、删除用户
- **选项9**: 证书管理 - 手动更新证书

### 🆕 增强功能管理
- **端口跳跃查看**: 通过Hysteria2管理菜单查看端口跳跃状态
- **定时任务管理**: 使用 `crontab -e` 查看或修改定时重启任务
- **防火墙状态**: 使用 `iptables -t nat -L` 查看端口跳跃规则

## 🚀 特色功能

### 🔄 自动化程度高
- 自动检测系统类型和版本
- 自动安装所有必要依赖 (包括iptables-persistent)
- 自动配置防火墙规则和端口跳跃
- 自动申请和配置SSL证书
- 自动配置系统定时维护任务

### 🌐 多协议共存
- 支持多种代理协议同时运行
- 智能端口分配避免冲突
- 统一管理界面
- Hysteria 2专享端口跳跃功能

### 🛡️ 安全性强
- 强制HTTPS和现代TLS版本
- 自动配置安全头
- 定期证书更新
- 防火墙规则持久化
- 端口跳跃增强连接稳定性

### 👥 用户友好
- 彩色输出和清晰提示
- 详细的错误信息和解决方案
- 支持一键卸载 (自动清理所有配置)
- 配置文件自动备份
- 增强功能状态实时反馈

### 🎯 系统维护
- 每日定时重启保持系统性能
- 自动清理临时文件和日志
- 智能任务管理避免冲突
- 完整的安装/卸载生命周期管理

## 注意事项

1. **系统要求**: 建议使用纯净的系统环境
2. **域名准备**: 需要提前准备好域名并正确解析
3. **防火墙**: 脚本会自动配置防火墙，请确保不与现有规则冲突
4. **SELinux**: CentOS用户需要关闭SELinux
5. **权限**: 需要root权限运行
6. **🆕 Swap 管理**: main.sh 会智能管理 swap，避免重复创建
7. **🆕 虚拟化兼容性**: OpenVZ 虚拟化不支持 swap 创建

## 🆕 main.sh 脚本优势

### 智能化管理
- **自动内存检测**: 无需手动计算 swap 大小
- **防重复创建**: 自动检测已存在的 swap 配置  
- **环境兼容性**: 自动检查虚拟化环境支持情况
- **用户友好**: 提供多种选择，满足不同需求
- **🆕 自动更新**: 内置更新功能，保持脚本最新状态

### 统一入口
- **脚本集成**: 一个入口管理所有安装脚本
- **状态保持**: 安装完成后返回主菜单
- **错误处理**: 文件不存在时友好提示
- **清晰导航**: 彩色界面和明确的选项说明
- **🆕 版本管理**: 智能检查更新，安全备份恢复

### 🆕 增强功能
- **定时重启配置**: V2Ray 安装后自动添加每日重启任务
- **远程脚本获取**: 始终执行最新版本的安装脚本
- **脚本自我更新**: 支持在线检查和更新 main.sh 本身
- **备份恢复机制**: 更新失败时自动恢复原版本

## 故障排除

### 🆕 main.sh 统一管理脚本问题
- **Swap 创建失败**: 
  ```bash
  # 检查磁盘空间
  df -h
  # 手动创建测试
  fallocate -l 1G /test_swapfile && rm /test_swapfile
  ```

- **脚本文件不存在**:
  ```bash
  # 检查文件是否存在
  ls -la *.sh
  # 重新下载缺失的脚本
  wget -O install.sh https://raw.githubusercontent.com/charleslkx/hy2/master/install.sh
  ```

- **权限问题**:
  ```bash
  # 确保以 root 权限运行
  sudo ./main.sh
  # 检查脚本权限
  chmod +x *.sh
  ```

- **🆕 脚本更新失败**:
  ```bash
  # 检查网络连接
  wget --spider https://raw.githubusercontent.com/charleslkx/hy2/master/main.sh
  # 手动下载更新
  wget -O main_new.sh https://raw.githubusercontent.com/charleslkx/hy2/master/main.sh
  chmod +x main_new.sh
  ```

- **🆕 定时重启任务问题**:
  ```bash
  # 查看定时任务
  crontab -l
  # 手动添加定时重启
  echo "0 5 * * * /sbin/reboot" | crontab -
  # 删除定时重启任务
  crontab -l | grep -v "/sbin/reboot" | crontab -
  ```

### 🆕 增强功能故障排除
- **端口跳跃不生效**: 
  ```bash
  # 检查iptables规则
  iptables -t nat -L PREROUTING | grep mack-a_hysteria2_portHopping
  # 检查端口开放状态
  netstat -ulnp | grep :30000
  ```

- **定时重启任务问题**:
  ```bash
  # 查看当前定时任务
  crontab -l
  # 手动删除重启任务
  crontab -e  # 删除包含 "0 5 * * * /sbin/reboot" 的行
  ```

- **iptables-persistent问题**:
  ```bash
  # 检查服务状态
  systemctl status netfilter-persistent
  # 手动保存规则
  iptables-save > /etc/iptables/rules.v4
  ```

### 日志查看
脚本运行过程中的日志保存在：
- 安装日志: `/etc/v2ray-agent/install.log`
- 证书日志: `/etc/v2ray-agent/tls/acme.log`
- 运行日志: 各协议独立日志文件
- 🆕 定时任务日志: 通过 `journalctl -u cron` 查看

## 鸣谢
感谢以下项目和作者的支持：
- v2ray-agent by mack-a (https://github.com/mack-a/v2ray-agent)
- v2ray by 233boy (https://github.com/233boy/v2ray)

## 免责声明

本脚本仅供学习和研究使用，请用户遵守当地法律法规。使用本脚本所产生的任何问题，作者不承担任何责任。增强版功能基于原版脚本开发，旨在提升用户体验和系统稳定性。

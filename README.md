# Hysteria 2 多协议一键安装脚本 (增强版-自用)

## 简介

这是一个基于V2Ray-Agent的八合一共存脚本，专门用于安装和管理Hysteria 2等多种代理协议的自动化部署脚本。该脚本支持多种操作系统，提供完整的安装、配置、管理功能，并集成了多项增强特性。

## 脚本信息

- **作者**: mack-a
- **版本**: v3.4.14 (增强版)
- **GitHub**: https://github.com/mack-a/v2ray-agent
- **描述**: 八合一共存脚本 + 自动端口跳跃 + 系统定时重启
- **增强功能**: 自动端口跳跃配置、iptables-persistent自动安装、定时重启管理


## 支持的系统

- **CentOS** 7/8
- **Debian** 9/10/11
- **Ubuntu** 18.04/20.04/22.04
- **Alpine Linux**

## 支持的协议

- **Hysteria 2** - 基于QUIC协议的高性能代理 (含自动端口跳跃)
- **REALITY** - 新一代反审查协议
- **Tuic** - 基于QUIC的轻量级代理
- **V2Ray** - 多协议代理平台
- **Xray** - V2Ray的超集版本
- **sing-box** - 新一代多协议代理工具

## 🆕 增强功能特性

### 🚀 自动端口跳跃
- **范围**: 30000-40000 (自动配置)
- **协议**: 专为Hysteria 2优化
- **智能**: 安装时自动配置，无需手动设置
- **持久化**: 自动保存到iptables-persistent

### 🛡️ 防火墙增强
- **iptables-persistent**: 自动安装和配置
- **规则持久化**: 重启后自动恢复防火墙规则
- **智能检测**: 避免重复安装和配置冲突

### ⏰ 系统维护自动化
- **定时重启**: 每日凌晨5:00自动重启
- **性能优化**: 保持系统最佳运行状态
- **智能管理**: 自动添加/清理定时任务

## 一键安装
```
bash <(wget -o- -qO- https://raw.githubusercontent.com/charleslkx/hy2/master/install.sh)
```

## 主要功能

### 1. 安装功能
- **一键安装**: 自动检测系统并安装所需组件
- **任意组合安装**: 支持多协议共存
- **自动依赖管理**: 自动安装必要的系统工具和依赖
- **iptables-persistent**: 自动安装并配置防火墙规则持久化
- **端口跳跃**: Hysteria 2自动配置端口跳跃(30000-40000)
- **定时维护**: 自动配置系统定时重启任务

### 2. 协议管理
- **Hysteria 2管理**: 端口跳跃、速度配置、用户管理 (自动端口跳跃)
- **REALITY管理**: 密钥生成、流量伪装
- **Tuic管理**: 配置优化、连接管理

### 3. 工具管理
- **用户管理**: 添加、删除、修改用户配置
- **伪装站管理**: 配置反向代理和伪装网站
- **证书管理**: 自动申请、更新SSL/TLS证书
- **CDN节点管理**: 优化全球访问速度
- **分流工具**: 智能路由和流量分流
- **新端口添加**: 动态端口配置
- **BT下载管理**: 流量控制和管理
- **域名黑名单**: 访问控制和安全防护
- **系统维护**: 自动配置定时重启任务

### 4. 版本管理
- **Core管理**: V2Ray、Xray、sing-box版本管理
- **脚本更新**: 自动检查和更新脚本版本
- **BBR安装**: 网络优化和加速

### 5. 安全功能
- **SELinux检查**: 自动检测和提示SELinux配置
- **防火墙配置**: 自动配置iptables规则
- **证书自动更新**: 定时任务自动续期证书
- **端口安全**: 动态端口和安全配置
- **规则持久化**: iptables-persistent自动保存防火墙规则

### 6. 🆕 系统维护功能
- **定时重启**: 每日凌晨5:00自动重启系统
- **性能优化**: 保持系统最佳运行状态
- **自动清理**: 卸载时自动清理所有配置
- **智能管理**: 避免重复配置和冲突

## 🆕 增强版特性说明

### 自动端口跳跃配置
- **自动激活**: 安装Hysteria 2时自动配置端口跳跃
- **端口范围**: 30000-40000 (固定范围，无需用户设置)
- **iptables规则**: 自动添加NAT转发规则
- **防火墙开放**: 自动开放UDP端口范围
- **规则持久化**: 通过iptables-persistent自动保存

### iptables-persistent自动安装
- **智能检测**: 仅在Debian/Ubuntu系统上安装
- **避免重复**: 检查是否已安装，避免重复配置
- **自动配置**: 预设置配置选项，避免交互式提示
- **规则保存**: 自动保存防火墙规则，重启后生效

### 系统定时重启管理
- **自动添加**: 安装时自动添加每日凌晨5:00重启任务
- **智能检测**: 避免重复添加相同的定时任务
- **完整清理**: 卸载时自动清理定时重启任务
- **用户友好**: 详细的设置完成提醒和管理指导

## 使用说明

### 首次安装
1. 运行脚本后会自动检测系统环境
2. 选择 "1.安装" 进行首次安装
3. 根据提示选择需要安装的协议
4. 输入域名等必要信息
5. 脚本将自动完成所有配置（包括端口跳跃和定时重启）

### 🆕 增强版安装流程
1. **系统检测**: 自动检测并安装iptables-persistent
2. **协议安装**: 安装选定的代理协议
3. **端口跳跃**: Hysteria 2自动配置30000-40000端口跳跃
4. **防火墙配置**: 自动配置并持久化iptables规则
5. **定时维护**: 自动添加每日凌晨5:00重启任务
6. **配置完成**: 显示详细的配置信息和管理指导

### 管理现有安装
- **选项4**: Hysteria2管理 - 配置端口、速度、用户等 (含端口跳跃管理)
- **选项5**: REALITY管理 - 管理REALITY协议配置
- **选项6**: Tuic管理 - 管理Tuic协议配置
- **选项7**: 用户管理 - 添加、删除用户
- **选项9**: 证书管理 - 手动更新证书

### 🆕 增强功能管理
- **端口跳跃查看**: 通过Hysteria2管理菜单查看端口跳跃状态
- **定时任务管理**: 使用 `crontab -e` 查看或修改定时重启任务
- **防火墙状态**: 使用 `iptables -t nat -L` 查看端口跳跃规则

## 🚀 特色功能

### 🔄 自动化程度高
- 自动检测系统类型和版本
- 自动安装所有必要依赖 (包括iptables-persistent)
- 自动配置防火墙规则和端口跳跃
- 自动申请和配置SSL证书
- 自动配置系统定时维护任务

### 🌐 多协议共存
- 支持多种代理协议同时运行
- 智能端口分配避免冲突
- 统一管理界面
- Hysteria 2专享端口跳跃功能

### 🛡️ 安全性强
- 强制HTTPS和现代TLS版本
- 自动配置安全头
- 定期证书更新
- 防火墙规则持久化
- 端口跳跃增强连接稳定性

### 👥 用户友好
- 彩色输出和清晰提示
- 详细的错误信息和解决方案
- 支持一键卸载 (自动清理所有配置)
- 配置文件自动备份
- 增强功能状态实时反馈

### 🎯 系统维护
- 每日定时重启保持系统性能
- 自动清理临时文件和日志
- 智能任务管理避免冲突
- 完整的安装/卸载生命周期管理

## 注意事项

1. **系统要求**: 建议使用纯净的系统环境
2. **域名准备**: 需要提前准备好域名并正确解析
3. **防火墙**: 脚本会自动配置防火墙，请确保不与现有规则冲突
4. **SELinux**: CentOS用户需要关闭SELinux
5. **权限**: 需要root权限运行

## 故障排除

### 常见问题
1. **证书申请失败**: 检查域名解析是否正确
2. **端口冲突**: 使用端口管理功能重新分配
3. **网络问题**: 检查防火墙和网络连接
4. **权限问题**: 确保以root权限运行
5. **🆕 端口跳跃问题**: 检查iptables服务是否正常运行
6. **🆕 定时重启问题**: 使用 `crontab -l` 检查定时任务状态

### 🆕 增强功能故障排除
- **端口跳跃不生效**: 
  ```bash
  # 检查iptables规则
  iptables -t nat -L PREROUTING | grep mack-a_hysteria2_portHopping
  # 检查端口开放状态
  netstat -ulnp | grep :30000
  ```

- **定时重启任务问题**:
  ```bash
  # 查看当前定时任务
  crontab -l
  # 手动删除重启任务
  crontab -e  # 删除包含 "0 5 * * * /sbin/reboot" 的行
  ```

- **iptables-persistent问题**:
  ```bash
  # 检查服务状态
  systemctl status netfilter-persistent
  # 手动保存规则
  iptables-save > /etc/iptables/rules.v4
  ```

### 日志查看
脚本运行过程中的日志保存在：
- 安装日志: `/etc/v2ray-agent/install.log`
- 证书日志: `/etc/v2ray-agent/tls/acme.log`
- 运行日志: 各协议独立日志文件
- 🆕 定时任务日志: 通过 `journalctl -u cron` 查看

## 🆕 增强版更新记录

### v3.4.14 增强版特性
- **✅ iptables-persistent自动安装**: 在安装工具时自动检测并安装
- **✅ Hysteria 2端口跳跃自动配置**: 30000-40000端口范围自动设置
- **✅ 防火墙规则持久化**: 自动保存iptables规则，重启后生效
- **✅ 系统定时重启**: 每日凌晨5:00自动重启系统
- **✅ 完整清理机制**: 卸载时自动清理所有增强功能配置
- **✅ 智能冲突检测**: 避免重复配置和规则冲突

### 原版功能保持
- **v3.4.14**: 当前版本，支持最新的协议和功能
- 集成iptables-persistent自动安装 (增强)
- 优化证书管理和自动更新
- 增强用户管理功能

### 增强版优势
1. **🚀 开箱即用**: 安装后即享受端口跳跃和系统维护
2. **🛡️ 安全增强**: 防火墙规则持久化，重启不丢失配置
3. **⚡ 性能优化**: 定时重启保持系统最佳状态
4. **🧹 完整清理**: 卸载时不留任何配置残余
5. **💡 智能管理**: 自动检测和避免配置冲突

## 支持与反馈

- **GitHub Issues**: https://github.com/mack-a/v2ray-agent/issues
- **官方文档**: https://www.v2ray-agent.com/
- **VPS选购**: https://www.v2ray-agent.com/archives/1679975663984
- **🆕 增强版反馈**: 欢迎提供增强功能的使用反馈和改进建议

## 免责声明

本脚本仅供学习和研究使用，请用户遵守当地法律法规。使用本脚本所产生的任何问题，作者不承担任何责任。增强版功能基于原版脚本开发，旨在提升用户体验和系统稳定性。
